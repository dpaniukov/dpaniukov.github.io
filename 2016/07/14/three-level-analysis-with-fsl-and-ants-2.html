<!DOCTYPE html>
<!-- saved from url=(0083)http://dpaniukov.github.io/2016/07/14/three-level-analysis-with-fsl-and-ants-2.html -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Three-level analysis with FSL and ANTs in Nipype. Part 2.</title>
  <meta name="description" content="Today we will be setting up levels 1 and 2 in a 3-level model with FSL and Nipype, applying transformation matrices from ANTs that we created in Part 1.">

  <link rel="stylesheet" href="./Three-level analysis with FSL and ANTs in Nipype. Part 2._files/main.css">
  <link rel="canonical" href="https://dpaniukov.github.io/2016/07/14/three-level-analysis-with-fsl-and-ants-2.html">
  <link rel="alternate" type="application/rss+xml" title="Dmitrii Paniukov" href="https://dpaniukov.github.io/feed.xml">
  <script async="" src="./Three-level analysis with FSL and ANTs in Nipype. Part 2._files/analytics.js"></script><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-78889004-1', 'auto');
  ga('send', 'pageview');

</script>

</head>


  <body data-gr-c-s-loaded="true">

    <header class="site-header">

  <div class="wrapper">

    <a href="http://dpaniukov.github.io/"><img width="58px" height="58px" src="./Three-level analysis with FSL and ANTs in Nipype. Part 2._files/dp64.png" alt="DP"></a>

    <nav class="site-nav">
      <a href="http://dpaniukov.github.io/2016/07/14/three-level-analysis-with-fsl-and-ants-2.html#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"></path>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"></path>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"></path>
        </svg>
      </a>
      <div class="trigger">
        
          
          <a class="page-link" href="http://dpaniukov.github.io/">Tutorials</a>
          
        
          
        
          
        
          
        
          
        

      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">Three-level analysis with FSL and ANTs in Nipype. Part 2.</h1>
  </header>

  <div class="post-content">
    <p>Today we will be setting up levels 1 and 2 in a 3-level model with FSL and Nipype, applying transformation matrices from ANTs that we created in <a href="https://dpaniukov.github.io/2016/07/03/three-level-analysis-with-fsl-and-ants-1.html">Part 1</a>.</p>

<h2 id="onset-and-contrast-files">Onset and contrast files</h2>
<p>Before we start running anything, we have to put some files in places. First, all level 1 onset files should be in <code class="highlighter-rouge">&lt;project directory&gt;/&lt;subject directory&gt;/&lt;model&gt;/&lt;model specific folder&gt;/onsets/&lt;task#_run#&gt;</code>. Next, we have to have a folder inside your main project directory called <code class="highlighter-rouge">models</code>. Under this folder, we will create a model specific folder with a description of EVs and contrasts. Thus, let’s create a folder <code class="highlighter-rouge">&lt;project directory&gt;/models/model_1</code>. Now let’s create the following files in there.
For level 1 we should have a file called <code class="highlighter-rouge">condition_key.txt</code> with the following content:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">task001 ev001 Stimuli_correct
task001 ev002 Stimuli_incorrect
task001 ev003 Stim_na
task001 ev004 Feedback_correct
task001 ev005 Feedback_incorrect
task001 ev006 Feedback_na</code></pre></figure>

<p>As you see in our example, we have 6 EVs, and should create contrasts like these in the <code class="highlighter-rouge">task_contrasts.txt</code>:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">task001 stim_cor 1 0 0 0 0 0
task001 stim_incor 0 1 0 0 0 0
task001 stim_cor&gt;stim_inc 1 -1 0 0 0 0
task001 fdb_cor 0 0 0 1 0 0
task001 fdb_incor 0 0 0 0 1 0
task001 fdb_cor&gt;fdb_incor 0 0 0 1 -1 0</code></pre></figure>

<p>This is how you create EVs and contrasts in Nipype. Let’s do it for level 2. By the way, the example experiment had two tasks.
<code class="highlighter-rouge">condition_key_l2.txt</code>:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">task001 ev001 task1
task001 ev002 task2</code></pre></figure>

<p>… and contrasts in <code class="highlighter-rouge">task_contrasts_l2.txt</code> to compare one task with another:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">task001 task1 1 0
task001 task2 0 1
task001 task1&gt;task2 1 -1</code></pre></figure>

<p>Ok, all external files are in place, so we can move to our main analysis script.</p>

<h2 id="preparation-and-preprocessing">Preparation and Preprocessing</h2>

<p>We need to import some libraries and interfaces to work with:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># -*- coding: utf-8 -*-</span>
<span class="c">#!/usr/bin/env python</span>
<span class="kn">import</span> <span class="nn">os</span><span class="p">,</span><span class="n">sys</span>
<span class="kn">import</span> <span class="nn">nipype.interfaces.io</span> <span class="k">as</span> <span class="n">nio</span>
<span class="kn">import</span> <span class="nn">nipype.interfaces.fsl</span> <span class="k">as</span> <span class="n">fsl</span>
<span class="kn">import</span> <span class="nn">nipype.interfaces.ants</span> <span class="k">as</span> <span class="n">ants</span>
<span class="kn">import</span> <span class="nn">nipype.pipeline.engine</span> <span class="k">as</span> <span class="n">pe</span>
<span class="kn">import</span> <span class="nn">nipype.interfaces.utility</span> <span class="k">as</span> <span class="n">util</span>
<span class="kn">import</span> <span class="nn">nipype.algorithms.modelgen</span> <span class="k">as</span> <span class="n">model</span>
<span class="kn">import</span> <span class="nn">errno</span></code></pre></figure>

<p>Assign output type for FSL, so it will create files <code class="highlighter-rouge">.nii.gz</code>:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">fsl</span><span class="o">.</span><span class="n">FSLCommand</span><span class="o">.</span><span class="n">set_default_output_type</span><span class="p">(</span><span class="s">'NIFTI_GZ'</span><span class="p">)</span></code></pre></figure>

<p>Now, let’s define some variables specific to our project. First, we will be needing the root project directory, where all our data are.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">project_dir</span><span class="o">=</span><span class="s">"&lt;path_to_directory&gt;"</span>
<span class="n">model_id</span><span class="o">=</span><span class="s">'_1'</span>
<span class="n">task_id</span><span class="o">=</span><span class="mi">1</span>
<span class="n">TR</span><span class="o">=</span><span class="mf">2.0</span>
<span class="n">fwhm_thr</span><span class="o">=</span><span class="mf">6.0</span> <span class="c">#smoothing kernel</span>
<span class="n">hpcutoff</span> <span class="o">=</span> <span class="mi">100</span> <span class="c"># highpass filter cutoff</span>
<span class="n">film_thr</span><span class="o">=</span><span class="mi">1000</span> <span class="c">#default in FSL</span>
<span class="n">film_ms</span><span class="o">=</span><span class="mi">5</span> <span class="c"># this should be Susan mask size, not fwhm</span>
<span class="n">template_brain</span> <span class="o">=</span> <span class="n">fsl</span><span class="o">.</span><span class="n">Info</span><span class="o">.</span><span class="n">standard_image</span><span class="p">(</span><span class="s">'MNI152_T1_2mm_brain.nii.gz'</span><span class="p">)</span></code></pre></figure>

<p>Then, we will also need a working directory, where we can put all temporary files, created by nipype. This directory should be specific for each analysis (alternatively, you can change the name of a workflow for each analysis), and may be deleted as soon as the analysis is finished. Besides, if your analyses use the same working directory and the node names overlap, most probably they will not run properly.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">work_dir</span><span class="o">=</span><span class="s">"&lt;path_to_directory&gt;"</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">work_dir</span><span class="p">)</span>
<span class="k">except</span> <span class="nb">OSError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">exc</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">errno</span><span class="o">.</span><span class="n">EEXIST</span> <span class="ow">or</span> <span class="n">exc</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="mi">17</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">exc</span>
    <span class="k">pass</span></code></pre></figure>

<p>I prefer to input from the command line which subjects to run because it is easier to parallel your jobs.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">subj_list</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></code></pre></figure>

<p>Now, let’s define the workflow.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">wf</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'wf'</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span><span class="s">"wdir"</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span><span class="o">+</span><span class="s">"lvl12"</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s">"execution"</span><span class="p">:</span> <span class="p">{</span><span class="s">"crashdump_dir"</span><span class="p">:</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">project_dir</span><span class="p">,</span><span class="s">'crashdumps'</span><span class="p">)}}</span></code></pre></figure>

<p>… and get a subject’s id:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">infosource</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">util</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s">'subject_id'</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s">"infosource"</span><span class="p">)</span>
<span class="n">infosource</span><span class="o">.</span><span class="n">iterables</span> <span class="o">=</span> <span class="p">(</span><span class="s">'subject_id'</span><span class="p">,</span> <span class="p">[</span><span class="n">subj_list</span><span class="p">])</span></code></pre></figure>

<p>Again, I am using just one subject per running job, so they are already in parallel. But in case you want to put all of them into this script and run in parallel (may the power of CPU be with you!), this is the place to do it (e.g., put <code class="highlighter-rouge">["Subject001","Subject002"]</code> instead of <code class="highlighter-rouge">[subj_list]</code>, and remove <code class="highlighter-rouge">subj_list</code> variable above.)</p>

<p>Here I use a function to get information for a specific subject. It may be different information such as ids for run numbers, condition information, etc.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">get_subjectinfo</span><span class="p">(</span><span class="n">subject_id</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">model_id</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>

    <span class="k">if</span> <span class="n">subject_id</span><span class="o">==</span><span class="s">"Subject003"</span> <span class="ow">or</span> <span class="n">subject_id</span><span class="o">==</span><span class="s">"Subject011"</span> <span class="ow">or</span> <span class="n">subject_id</span><span class="o">==</span><span class="s">"Subject016"</span> <span class="ow">or</span> <span class="n">subject_id</span><span class="o">==</span><span class="s">"Subject020"</span><span class="p">:</span>
        <span class="n">run_id</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">]</span>
        <span class="n">itk_id</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">run_id</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">evs_l2</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">ev001</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">ev002</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">subject_id</span><span class="o">==</span><span class="s">"Subject019"</span><span class="p">:</span>
        <span class="n">run_id</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">]</span>
        <span class="n">itk_id</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">run_id</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">evs_l2</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">ev001</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">ev002</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">run_id</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">]</span>
        <span class="n">itk_id</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">run_id</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">evs_l2</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">ev001</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">ev002</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

    <span class="c">#Conditions for level 1</span>
    <span class="n">condition_info</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cond_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s">'models'</span><span class="p">,</span> <span class="s">'model</span><span class="si">%</span><span class="s">s'</span> <span class="o">%</span> <span class="n">model_id</span><span class="p">,</span>
                             <span class="s">'condition_key.txt'</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cond_file</span><span class="p">,</span> <span class="s">'rt'</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">condition_info</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">' '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="mi">2</span><span class="p">:])])</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">condition_info</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="s">'No condition info found in </span><span class="si">%</span><span class="s">s'</span> <span class="o">%</span> <span class="n">cond_file</span><span class="p">)</span>
    <span class="n">taskinfo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">condition_info</span><span class="p">)</span>
    <span class="n">n_tasks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">taskinfo</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]))</span>
    <span class="n">conds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">task_id</span> <span class="o">&gt;</span> <span class="n">n_tasks</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="s">'Task id </span><span class="si">%</span><span class="s">d does not exist'</span> <span class="o">%</span> <span class="n">task_id</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_tasks</span><span class="p">):</span>
        <span class="n">taskidx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">taskinfo</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">'task</span><span class="si">%03</span><span class="s">d'</span> <span class="o">%</span> <span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">conds</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">condition</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">' '</span><span class="p">,</span> <span class="s">'_'</span><span class="p">)</span> <span class="k">for</span> <span class="n">condition</span>
                      <span class="ow">in</span> <span class="n">taskinfo</span><span class="p">[</span><span class="n">taskidx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">]])</span>

    <span class="c">#Conditions for level 2</span>
    <span class="n">condition_info_l2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cond_file_l2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s">'models'</span><span class="p">,</span> <span class="s">'model</span><span class="si">%</span><span class="s">s'</span> <span class="o">%</span> <span class="n">model_id</span><span class="p">,</span>
                             <span class="s">'condition_key_l2.txt'</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cond_file_l2</span><span class="p">,</span> <span class="s">'rt'</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp_l2</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fp_l2</span><span class="p">:</span>
            <span class="n">info_l2</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">condition_info_l2</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">info_l2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">info_l2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">' '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">info_l2</span><span class="p">[</span><span class="mi">2</span><span class="p">:])])</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">condition_info_l2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="s">'No condition info found in </span><span class="si">%</span><span class="s">s'</span> <span class="o">%</span> <span class="n">cond_file_l2</span><span class="p">)</span>
    <span class="n">taskinfo_l2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">condition_info_l2</span><span class="p">)</span>
    <span class="n">n_tasks_l2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">taskinfo_l2</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]))</span>
    <span class="n">conds_l2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">task_id</span> <span class="o">&gt;</span> <span class="n">n_tasks_l2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="s">'Task id </span><span class="si">%</span><span class="s">d does not exist'</span> <span class="o">%</span> <span class="n">task_id</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_tasks_l2</span><span class="p">):</span>
        <span class="n">taskidx_l2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">taskinfo_l2</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">'task</span><span class="si">%03</span><span class="s">d'</span> <span class="o">%</span> <span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">conds_l2</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">condition_l2</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">' '</span><span class="p">,</span> <span class="s">'_'</span><span class="p">)</span> <span class="k">for</span> <span class="n">condition_l2</span>
                      <span class="ow">in</span> <span class="n">taskinfo_l2</span><span class="p">[</span><span class="n">taskidx_l2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">]])</span>

    <span class="k">return</span> <span class="n">subject_id</span><span class="p">,</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">run_id</span><span class="p">,</span> <span class="n">conds</span><span class="p">[</span><span class="n">task_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">itk_id</span><span class="p">,</span> <span class="n">evs_l2</span><span class="p">,</span> <span class="n">conds_l2</span><span class="p">[</span><span class="n">task_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span></code></pre></figure>

<p>Let’s stop for a moment and take a look at what’s going on here. Some subjects had no run 1 (because of a visual spike, it was removed), and some had no last runs (did not finish the experiment), thus <code class="highlighter-rouge">run_id</code> is different for some subjects. <code class="highlighter-rouge">itk_id</code> was made to indicate an appropriate run. Nipype counts the runs starting at 0, while I counted them starting at 1, thus, the run numbers are adjusted for files made by Nipype earlier. <code class="highlighter-rouge">evs_l2</code> is a vector of ones (1) for each of two tasks. In most of the cases you will be using only one EV at level 2 to combine runs across subjects; and you will have something like this: <code class="highlighter-rouge">evs_l2=dict(ev001=[1,1,1,1,1,1,1,1])</code>. Everything under that just parses out the condition files for each run and each level.</p>

<p>Prepare the node to run the function above and grab subject-specific data as we did in the <a href="https://dpaniukov.github.io/2016/07/03/three-level-analysis-with-fsl-and-ants-1.html">Part 1</a>:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">subjinfo</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s">'subject_id'</span><span class="p">,</span><span class="s">'base_dir'</span><span class="p">,</span> <span class="s">'task_id'</span><span class="p">,</span> <span class="s">'model_id'</span><span class="p">],</span>
                                <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s">'subject_id'</span><span class="p">,</span><span class="s">'model_id'</span><span class="p">,</span><span class="s">'task_id'</span><span class="p">,</span><span class="s">'run_id'</span><span class="p">,</span><span class="s">'conds'</span><span class="p">,</span><span class="s">'itk_id'</span><span class="p">,</span><span class="s">'evs_l2'</span><span class="p">,</span><span class="s">'conds_l2'</span><span class="p">],</span>
                                <span class="n">function</span><span class="o">=</span><span class="n">get_subjectinfo</span><span class="p">),</span>
                       <span class="n">name</span><span class="o">=</span><span class="s">'subjectinfo'</span><span class="p">)</span>
<span class="n">subjinfo</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">=</span> <span class="n">project_dir</span>
<span class="n">subjinfo</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">task_id</span> <span class="o">=</span> <span class="n">task_id</span>
<span class="n">subjinfo</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">model_id</span> <span class="o">=</span> <span class="n">model_id</span>

<span class="n">datasource</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">nio</span><span class="o">.</span><span class="n">DataGrabber</span><span class="p">(</span><span class="n">infields</span><span class="o">=</span><span class="p">[</span><span class="s">'subject_id'</span><span class="p">,</span><span class="s">'model_id'</span><span class="p">,</span><span class="s">'task_id'</span><span class="p">,</span><span class="s">'run_id'</span><span class="p">,</span><span class="s">'itk_id'</span><span class="p">],</span>
                                              <span class="n">outfields</span><span class="o">=</span><span class="p">[</span><span class="s">'func'</span><span class="p">,</span> <span class="s">'struct'</span><span class="p">,</span><span class="s">'behave'</span><span class="p">,</span><span class="s">'contrasts'</span><span class="p">,</span>
                                              <span class="s">'contrasts_l2'</span><span class="p">,</span><span class="s">'confound'</span><span class="p">,</span><span class="s">'itk_transform'</span><span class="p">,</span>
                                              <span class="s">'composite_transform'</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s">'grabber'</span><span class="p">)</span>
<span class="n">datasource</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">base_directory</span> <span class="o">=</span> <span class="n">project_dir</span>
<span class="n">datasource</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="s">'*'</span>
<span class="n">datasource</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">field_template</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="s">'</span><span class="si">%</span><span class="s">s/bold/run</span><span class="si">%</span><span class="s">d/run*_mcf_brain.nii.gz'</span><span class="p">,</span>
                                        <span class="n">struct</span><span class="o">=</span><span class="s">'</span><span class="si">%</span><span class="s">s/anatomy/highres001_BrainExtractionBrain.nii.gz'</span><span class="p">,</span>
                                        <span class="n">behave</span><span class="o">=</span><span class="s">'</span><span class="si">%</span><span class="s">s/model/model</span><span class="si">%</span><span class="s">s/onsets/task</span><span class="si">%03</span><span class="s">d_run</span><span class="si">%</span><span class="s">d/ev*.txt'</span><span class="p">,</span>
                                        <span class="n">contrasts</span><span class="o">=</span><span class="s">'models/model</span><span class="si">%</span><span class="s">s/task_contrasts.txt'</span><span class="p">,</span>
                                        <span class="n">contrasts_l2</span><span class="o">=</span><span class="s">'models/model</span><span class="si">%</span><span class="s">s/task_contrasts_l2.txt'</span><span class="p">,</span>
                                        <span class="n">confound</span><span class="o">=</span><span class="s">'</span><span class="si">%</span><span class="s">s/bold/run</span><span class="si">%</span><span class="s">d/QA/confound3.txt'</span><span class="p">,</span>
                                        <span class="n">itk_transform</span><span class="o">=</span><span class="s">'reg/</span><span class="si">%</span><span class="s">s/bold/func2standard_mat/_subject_id_</span><span class="si">%</span><span class="s">s/_convert2itk</span><span class="si">%</span><span class="s">d/affine.txt'</span><span class="p">,</span>
                                        <span class="n">composite_transform</span><span class="o">=</span><span class="s">'reg/</span><span class="si">%</span><span class="s">s/anatomy/anat2standard_mat/_subject_id_</span><span class="si">%</span><span class="s">s/output_Composite.h5'</span><span class="p">)</span>
<span class="n">datasource</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">template_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="p">[[</span><span class="s">'subject_id'</span><span class="p">,</span><span class="s">'run_id'</span><span class="p">]],</span>
                                       <span class="n">struct</span><span class="o">=</span><span class="p">[[</span><span class="s">'subject_id'</span><span class="p">]],</span>
                                        <span class="n">behave</span><span class="o">=</span><span class="p">[[</span><span class="s">'subject_id'</span><span class="p">,</span><span class="s">'model_id'</span><span class="p">,</span><span class="s">'task_id'</span><span class="p">,</span><span class="s">'run_id'</span><span class="p">]],</span>
                                        <span class="n">contrasts</span><span class="o">=</span><span class="p">[[</span><span class="s">'model_id'</span><span class="p">]],</span>
                                        <span class="n">contrasts_l2</span><span class="o">=</span><span class="p">[[</span><span class="s">'model_id'</span><span class="p">]],</span>
                                        <span class="n">confound</span><span class="o">=</span><span class="p">[[</span><span class="s">'subject_id'</span><span class="p">,</span><span class="s">'run_id'</span><span class="p">]],</span>
                                        <span class="n">itk_transform</span><span class="o">=</span><span class="p">[[</span><span class="s">'subject_id'</span><span class="p">,</span><span class="s">'subject_id'</span><span class="p">,</span><span class="s">'itk_id'</span><span class="p">]],</span>
                                        <span class="n">composite_transform</span><span class="o">=</span><span class="p">[[</span><span class="s">'subject_id'</span><span class="p">,</span><span class="s">'subject_id'</span><span class="p">]])</span>
<span class="n">datasource</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">sort_filelist</span><span class="o">=</span><span class="bp">True</span>

<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">([(</span><span class="n">infosource</span><span class="p">,</span> <span class="n">subjinfo</span><span class="p">,</span> <span class="p">[(</span><span class="s">'subject_id'</span><span class="p">,</span> <span class="s">'subject_id'</span><span class="p">)]),])</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">subjinfo</span><span class="p">,</span> <span class="s">'subject_id'</span><span class="p">,</span> <span class="n">datasource</span><span class="p">,</span> <span class="s">'subject_id'</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">subjinfo</span><span class="p">,</span> <span class="s">'model_id'</span><span class="p">,</span> <span class="n">datasource</span><span class="p">,</span> <span class="s">'model_id'</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">subjinfo</span><span class="p">,</span> <span class="s">'task_id'</span><span class="p">,</span> <span class="n">datasource</span><span class="p">,</span> <span class="s">'task_id'</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">subjinfo</span><span class="p">,</span> <span class="s">'run_id'</span><span class="p">,</span> <span class="n">datasource</span><span class="p">,</span> <span class="s">'run_id'</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">subjinfo</span><span class="p">,</span> <span class="s">'itk_id'</span><span class="p">,</span> <span class="n">datasource</span><span class="p">,</span> <span class="s">'itk_id'</span><span class="p">)</span></code></pre></figure>

<p>Here we import functional and structural scans, onset files, contrast files, and transformation matrices.</p>

<p>Set up a node to define all inputs required for the preprocessing workflow</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">inputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">util</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s">'func'</span><span class="p">,</span><span class="s">'struct'</span><span class="p">,]),</span>
                    <span class="n">name</span><span class="o">=</span><span class="s">'inputspec'</span><span class="p">)</span>

<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">([(</span><span class="n">datasource</span><span class="p">,</span> <span class="n">inputnode</span><span class="p">,</span> <span class="p">[(</span><span class="s">'struct'</span><span class="p">,</span><span class="s">'struct'</span><span class="p">),(</span><span class="s">'func'</span><span class="p">,</span> <span class="s">'func'</span><span class="p">),]),])</span></code></pre></figure>

<p>Convert functional images to float representation. Since there can be more than one functional run we use a MapNode to convert each run.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">prefiltered_func_data</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageMaths</span><span class="p">(</span><span class="n">out_data_type</span><span class="o">=</span><span class="s">'float'</span><span class="p">,</span>
                                             <span class="n">op_string</span> <span class="o">=</span> <span class="s">''</span><span class="p">,</span>
                                             <span class="n">suffix</span><span class="o">=</span><span class="s">'_dtype'</span><span class="p">),</span>
                       <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s">'in_file'</span><span class="p">],</span>
                       <span class="n">name</span><span class="o">=</span><span class="s">'prefiltered_func_data'</span><span class="p">)</span>

<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s">'func'</span><span class="p">,</span> <span class="n">prefiltered_func_data</span><span class="p">,</span> <span class="s">'in_file'</span><span class="p">)</span></code></pre></figure>

<p>Determine the 2nd and 98th percentile intensities of each functional run</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">getthresh</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageStats</span><span class="p">(</span><span class="n">op_string</span><span class="o">=</span><span class="s">'-p 2 -p 98'</span><span class="p">),</span>
                       <span class="n">iterfield</span> <span class="o">=</span> <span class="p">[</span><span class="s">'in_file'</span><span class="p">],</span>
                       <span class="n">name</span><span class="o">=</span><span class="s">'getthreshold'</span><span class="p">)</span>

<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">prefiltered_func_data</span><span class="p">,</span> <span class="s">'out_file'</span><span class="p">,</span> <span class="n">getthresh</span><span class="p">,</span> <span class="s">'in_file'</span><span class="p">)</span></code></pre></figure>

<p>Threshold the first run of the functional data at 10% of the 98th percentile</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">threshold</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageMaths</span><span class="p">(</span><span class="n">out_data_type</span><span class="o">=</span><span class="s">'char'</span><span class="p">,</span>
                                             <span class="n">suffix</span><span class="o">=</span><span class="s">'_thresh'</span><span class="p">),</span>
                    <span class="n">iterfield</span> <span class="o">=</span> <span class="p">[</span><span class="s">'in_file'</span><span class="p">],</span>
                    <span class="n">name</span><span class="o">=</span><span class="s">'threshold'</span><span class="p">)</span></code></pre></figure>

<p>Define a function to get 10% of the intensity</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">getthreshop</span><span class="p">(</span><span class="n">thresh</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">'-thr </span><span class="si">%.10</span><span class="s">f -Tmin -bin'</span><span class="o">%</span><span class="p">(</span><span class="mf">0.1</span><span class="o">*</span><span class="n">thresh</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>

<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">prefiltered_func_data</span><span class="p">,</span> <span class="s">'out_file'</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="s">'in_file'</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">getthresh</span><span class="p">,</span> <span class="p">(</span><span class="s">'out_stat'</span><span class="p">,</span> <span class="n">getthreshop</span><span class="p">),</span> <span class="n">threshold</span><span class="p">,</span> <span class="s">'op_string'</span><span class="p">)</span></code></pre></figure>

<p>Determine the median value of the functional runs using the mask</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">medianval</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageStats</span><span class="p">(</span><span class="n">op_string</span><span class="o">=</span><span class="s">'-k </span><span class="si">%</span><span class="s">s -p 50'</span><span class="p">),</span>
                       <span class="n">iterfield</span> <span class="o">=</span> <span class="p">[</span><span class="s">'in_file'</span><span class="p">,</span><span class="s">'mask_file'</span><span class="p">],</span>
                       <span class="n">name</span><span class="o">=</span><span class="s">'medianval'</span><span class="p">)</span>

<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">prefiltered_func_data</span><span class="p">,</span> <span class="s">'out_file'</span><span class="p">,</span> <span class="n">medianval</span><span class="p">,</span> <span class="s">'in_file'</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="s">'out_file'</span><span class="p">,</span> <span class="n">medianval</span><span class="p">,</span> <span class="s">'mask_file'</span><span class="p">)</span></code></pre></figure>

<p>Dilate the mask. This is the final mask for level 1.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">dilatemask</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageMaths</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s">'_dil'</span><span class="p">,</span>
                                              <span class="n">op_string</span><span class="o">=</span><span class="s">'-dilF'</span><span class="p">),</span>
                    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s">'in_file'</span><span class="p">],</span>
                     <span class="n">name</span><span class="o">=</span><span class="s">'dilatemask'</span><span class="p">)</span>

<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="s">'out_file'</span><span class="p">,</span> <span class="n">dilatemask</span><span class="p">,</span> <span class="s">'in_file'</span><span class="p">)</span></code></pre></figure>

<p>Mask the motion corrected functional runs with the dilated mask</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">prefiltered_func_data_thresh</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageMaths</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s">'_mask'</span><span class="p">,</span>
                                                <span class="n">op_string</span><span class="o">=</span><span class="s">'-mas'</span><span class="p">),</span>
                       <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s">'in_file'</span><span class="p">,</span><span class="s">'in_file2'</span><span class="p">],</span>
                       <span class="n">name</span><span class="o">=</span><span class="s">'prefiltered_func_data_thresh'</span><span class="p">)</span>

<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">prefiltered_func_data</span><span class="p">,</span> <span class="s">'out_file'</span><span class="p">,</span> <span class="n">prefiltered_func_data_thresh</span><span class="p">,</span> <span class="s">'in_file'</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dilatemask</span><span class="p">,</span> <span class="s">'out_file'</span><span class="p">,</span> <span class="n">prefiltered_func_data_thresh</span><span class="p">,</span> <span class="s">'in_file2'</span><span class="p">)</span></code></pre></figure>

<p>Determine the mean image from each functional run</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">meanfunc2</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageMaths</span><span class="p">(</span><span class="n">op_string</span><span class="o">=</span><span class="s">'-Tmean'</span><span class="p">,</span>
                                                <span class="n">suffix</span><span class="o">=</span><span class="s">'_mean'</span><span class="p">),</span>
                       <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s">'in_file'</span><span class="p">],</span>
                       <span class="n">name</span><span class="o">=</span><span class="s">'meanfunc2'</span><span class="p">)</span>

<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">prefiltered_func_data_thresh</span><span class="p">,</span> <span class="s">'out_file'</span><span class="p">,</span> <span class="n">meanfunc2</span><span class="p">,</span> <span class="s">'in_file'</span><span class="p">)</span></code></pre></figure>

<p>Merge the median values with the mean functional images into a coupled list</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#Yes, it is Node with iterfield! Not MapNode.</span>
<span class="n">mergenode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">util</span><span class="o">.</span><span class="n">Merge</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s">'hstack'</span><span class="p">),</span>
                       <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s">'in1'</span><span class="p">,</span><span class="s">'in2'</span><span class="p">],</span>
                       <span class="n">name</span><span class="o">=</span><span class="s">'merge'</span><span class="p">)</span>

<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">meanfunc2</span><span class="p">,</span><span class="s">'out_file'</span><span class="p">,</span> <span class="n">mergenode</span><span class="p">,</span> <span class="s">'in1'</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">medianval</span><span class="p">,</span><span class="s">'out_stat'</span><span class="p">,</span> <span class="n">mergenode</span><span class="p">,</span> <span class="s">'in2'</span><span class="p">)</span></code></pre></figure>

<p>Smooth each run using SUSAN with the brightness threshold set to 75% of the median value for each run and a mask constituting the mean functional</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">smooth</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">SUSAN</span><span class="p">(),</span>
                    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s">'in_file'</span><span class="p">,</span> <span class="s">'brightness_threshold'</span><span class="p">,</span><span class="s">'usans'</span><span class="p">],</span>
                    <span class="n">name</span><span class="o">=</span><span class="s">'smooth'</span><span class="p">)</span>
<span class="n">smooth</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">=</span> <span class="n">fwhm_thr</span></code></pre></figure>

<p>Here I have to note that if you will be replicating the same in FSL, you won’t get exact same copes. The reason is that Nipype uses a standard formula to calculate smoothing: <code class="highlighter-rouge">sqrt(8*log(2))</code> when FSL uses a different formula. Thus, to completely replicate FSL, you should use <code class="highlighter-rouge">fwhm_thr=5.999541516002418</code> instead of <code class="highlighter-rouge">fwhm_thr=6.0</code> we used above.</p>

<p>Define a function to get the brightness threshold for SUSAN</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">getbtthresh</span><span class="p">(</span><span class="n">medianvals</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="mf">0.75</span><span class="o">*</span><span class="n">val</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">medianvals</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">getusans</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[[</span><span class="nb">tuple</span><span class="p">([</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mf">0.75</span><span class="o">*</span><span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]])]</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>

<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">prefiltered_func_data_thresh</span><span class="p">,</span> <span class="s">'out_file'</span><span class="p">,</span> <span class="n">smooth</span><span class="p">,</span> <span class="s">'in_file'</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">medianval</span><span class="p">,</span> <span class="p">(</span><span class="s">'out_stat'</span><span class="p">,</span> <span class="n">getbtthresh</span><span class="p">),</span> <span class="n">smooth</span><span class="p">,</span> <span class="s">'brightness_threshold'</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">mergenode</span><span class="p">,</span> <span class="p">(</span><span class="s">'out'</span><span class="p">,</span> <span class="n">getusans</span><span class="p">),</span> <span class="n">smooth</span><span class="p">,</span> <span class="s">'usans'</span><span class="p">)</span></code></pre></figure>

<p>Mask the smoothed data with the dilated mask</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">maskfunc3</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageMaths</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s">'_mask'</span><span class="p">,</span>
                                                <span class="n">op_string</span><span class="o">=</span><span class="s">'-mas'</span><span class="p">),</span>
                       <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s">'in_file'</span><span class="p">,</span> <span class="s">'in_file2'</span><span class="p">],</span>
                       <span class="n">name</span><span class="o">=</span><span class="s">'maskfunc3'</span><span class="p">)</span>

<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">smooth</span><span class="p">,</span> <span class="s">'smoothed_file'</span><span class="p">,</span> <span class="n">maskfunc3</span><span class="p">,</span> <span class="s">'in_file'</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dilatemask</span><span class="p">,</span> <span class="s">'out_file'</span><span class="p">,</span> <span class="n">maskfunc3</span><span class="p">,</span> <span class="s">'in_file2'</span><span class="p">)</span></code></pre></figure>

<p>Scale each volume of the run so that the median value of the run is set to 10000</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">intnorm</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageMaths</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s">'_intnorm'</span><span class="p">),</span>
                     <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s">'in_file'</span><span class="p">,</span><span class="s">'op_string'</span><span class="p">],</span>
                     <span class="n">name</span><span class="o">=</span><span class="s">'intnorm'</span><span class="p">)</span></code></pre></figure>

<p>Define a function to get the scaling factor for intensity normalization</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">getinormscale</span><span class="p">(</span><span class="n">medianvals</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="s">'-mul </span><span class="si">%.10</span><span class="s">f'</span><span class="o">%</span><span class="p">(</span><span class="mf">10000.</span><span class="o">/</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">medianvals</span><span class="p">]</span>

<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">maskfunc3</span><span class="p">,</span> <span class="s">'out_file'</span><span class="p">,</span> <span class="n">intnorm</span><span class="p">,</span> <span class="s">'in_file'</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">medianval</span><span class="p">,</span> <span class="p">(</span><span class="s">'out_stat'</span><span class="p">,</span> <span class="n">getinormscale</span><span class="p">),</span> <span class="n">intnorm</span><span class="p">,</span> <span class="s">'op_string'</span><span class="p">)</span></code></pre></figure>

<p>Create tempMean</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">tempMean</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageMaths</span><span class="p">(</span><span class="n">op_string</span><span class="o">=</span><span class="s">'-Tmean'</span><span class="p">,</span>
                                                <span class="n">suffix</span><span class="o">=</span><span class="s">'_mean'</span><span class="p">),</span>
                       <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s">'in_file'</span><span class="p">],</span>
                       <span class="n">name</span><span class="o">=</span><span class="s">'tempMean'</span><span class="p">)</span>

<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">intnorm</span><span class="p">,</span> <span class="s">'out_file'</span><span class="p">,</span> <span class="n">tempMean</span><span class="p">,</span> <span class="s">'in_file'</span><span class="p">)</span></code></pre></figure>

<p>Perform temporal highpass filtering on the data. This is the same as <code class="highlighter-rouge">filtered_func_data</code> in FSL output.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">highpass</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageMaths</span><span class="p">(</span><span class="n">op_string</span><span class="o">=</span> <span class="s">'-bptf </span><span class="si">%</span><span class="s">d -1 -add'</span><span class="o">%</span><span class="p">(</span><span class="n">hpcutoff</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">TR</span><span class="p">)),</span> <span class="n">suffix</span><span class="o">=</span><span class="s">'_tempfilt'</span><span class="p">),</span>
                      <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s">'in_file'</span><span class="p">,</span><span class="s">'in_file2'</span><span class="p">],</span>
                      <span class="n">name</span><span class="o">=</span><span class="s">'highpass'</span><span class="p">)</span>

<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">tempMean</span><span class="p">,</span> <span class="s">'out_file'</span><span class="p">,</span> <span class="n">highpass</span><span class="p">,</span> <span class="s">'in_file2'</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">intnorm</span><span class="p">,</span> <span class="s">'out_file'</span><span class="p">,</span> <span class="n">highpass</span><span class="p">,</span> <span class="s">'in_file'</span><span class="p">)</span></code></pre></figure>

<p>We’ve done with preprocessing! Hooray! Now, let’s see how to code the level 1.</p>

<h2 id="level-1">Level 1</h2>

<p>Setup a basic set of contrasts</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">get_contrasts</span><span class="p">(</span><span class="n">contrast_file</span><span class="p">,</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">conds</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
    <span class="n">contrast_def</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">contrast_file</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">contrast_def</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">contrast_def</span> <span class="o">=</span> <span class="n">contrast_def</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">contrasts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">contrast_def</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">'task</span><span class="si">%03</span><span class="s">d'</span> <span class="o">%</span> <span class="n">task_id</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">con</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">'T'</span><span class="p">,</span> <span class="p">[</span><span class="s">'ev</span><span class="si">%03</span><span class="s">d'</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">conds</span><span class="p">))],</span>
               <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>
        <span class="n">contrasts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">con</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">contrasts</span>

<span class="n">contrastgen</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s">'contrast_file'</span><span class="p">,</span>
                                                <span class="s">'task_id'</span><span class="p">,</span> <span class="s">'conds'</span><span class="p">],</span>
                                   <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s">'contrasts'</span><span class="p">],</span>
                                   <span class="n">function</span><span class="o">=</span><span class="n">get_contrasts</span><span class="p">),</span>
                      <span class="n">name</span><span class="o">=</span><span class="s">'contrastgen'</span><span class="p">)</span>

<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">subjinfo</span><span class="p">,</span> <span class="s">'conds'</span><span class="p">,</span> <span class="n">contrastgen</span><span class="p">,</span> <span class="s">'conds'</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">datasource</span><span class="p">,</span> <span class="s">'contrasts'</span><span class="p">,</span> <span class="n">contrastgen</span><span class="p">,</span> <span class="s">'contrast_file'</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">subjinfo</span><span class="p">,</span> <span class="s">'task_id'</span><span class="p">,</span> <span class="n">contrastgen</span><span class="p">,</span> <span class="s">'task_id'</span><span class="p">)</span></code></pre></figure>

<p>Generate design information</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">check_behav_list</span><span class="p">(</span><span class="n">behav</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">nipype.external</span> <span class="kn">import</span> <span class="n">six</span>
    <span class="n">out_behav</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">behav</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
        <span class="n">behav</span> <span class="o">=</span> <span class="p">[</span><span class="n">behav</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">behav</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">out_behav</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">val</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out_behav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out_behav</span>

<span class="n">modelspec</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">SpecifyModel</span><span class="p">(),</span>
                      <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s">'event_files'</span><span class="p">,</span><span class="s">'functional_runs'</span><span class="p">],</span>
                      <span class="n">name</span><span class="o">=</span><span class="s">"modelspec"</span><span class="p">)</span>
<span class="n">modelspec</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">input_units</span> <span class="o">=</span> <span class="s">'secs'</span>
<span class="n">modelspec</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">high_pass_filter_cutoff</span> <span class="o">=</span> <span class="n">hpcutoff</span>
<span class="n">modelspec</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">time_repetition</span><span class="o">=</span><span class="n">TR</span>

<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">datasource</span><span class="p">,</span> <span class="p">(</span><span class="s">'behave'</span><span class="p">,</span> <span class="n">check_behav_list</span><span class="p">),</span> <span class="n">modelspec</span><span class="p">,</span> <span class="s">'event_files'</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">highpass</span><span class="p">,</span> <span class="s">'out_file'</span><span class="p">,</span> <span class="n">modelspec</span><span class="p">,</span> <span class="s">'functional_runs'</span><span class="p">)</span></code></pre></figure>

<p>Generate a run specific .fsf file for analysis</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">level1design</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">Level1Design</span><span class="p">(),</span>
                          <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s">'session_info'</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s">"level1design"</span><span class="p">)</span>
<span class="n">level1design</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">interscan_interval</span><span class="o">=</span><span class="n">TR</span>
<span class="n">level1design</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">bases</span> <span class="o">=</span> <span class="p">{</span><span class="s">'dgamma'</span><span class="p">:{</span><span class="s">'derivs'</span><span class="p">:</span> <span class="bp">True</span><span class="p">}}</span>
<span class="n">level1design</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">model_serial_correlations</span> <span class="o">=</span> <span class="bp">True</span>

<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">contrastgen</span><span class="p">,</span> <span class="s">'contrasts'</span><span class="p">,</span> <span class="n">level1design</span><span class="p">,</span> <span class="s">'contrasts'</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">modelspec</span><span class="p">,</span> <span class="s">'session_info'</span><span class="p">,</span> <span class="n">level1design</span><span class="p">,</span> <span class="s">'session_info'</span><span class="p">)</span></code></pre></figure>

<p>Generate a run specific .mat file for use by FILMGLS</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">modelgen</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">FEATModel</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">'modelgen'</span><span class="p">,</span>
                      <span class="n">iterfield</span> <span class="o">=</span> <span class="p">[</span><span class="s">'fsf_file'</span><span class="p">,</span> <span class="s">'ev_files'</span><span class="p">,</span><span class="s">'args'</span><span class="p">])</span>

<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">level1design</span><span class="p">,</span> <span class="s">'ev_files'</span><span class="p">,</span> <span class="n">modelgen</span><span class="p">,</span> <span class="s">'ev_files'</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">level1design</span><span class="p">,</span> <span class="s">'fsf_files'</span><span class="p">,</span> <span class="n">modelgen</span><span class="p">,</span> <span class="s">'fsf_file'</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">datasource</span><span class="p">,</span> <span class="s">'confound'</span><span class="p">,</span> <span class="n">modelgen</span><span class="p">,</span> <span class="s">'args'</span><span class="p">)</span></code></pre></figure>

<p>Estimate a model specified by a .mat file and a functional run</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">modelestimate</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">FILMGLS</span><span class="p">(</span><span class="n">smooth_autocorr</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                                 <span class="n">mask_size</span><span class="o">=</span><span class="n">film_ms</span><span class="p">,</span>
                                                 <span class="n">threshold</span><span class="o">=</span><span class="n">film_thr</span><span class="p">),</span>
                           <span class="n">name</span><span class="o">=</span><span class="s">'modelestimate'</span><span class="p">,</span>
                           <span class="n">iterfield</span> <span class="o">=</span> <span class="p">[</span><span class="s">'design_file'</span><span class="p">,</span><span class="s">'in_file'</span><span class="p">,</span><span class="s">'tcon_file'</span><span class="p">])</span>

<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">([(</span><span class="n">highpass</span><span class="p">,</span><span class="n">modelestimate</span><span class="p">,[(</span><span class="s">'out_file'</span><span class="p">,</span><span class="s">'in_file'</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">modelgen</span><span class="p">,</span><span class="n">modelestimate</span><span class="p">,[(</span><span class="s">'design_file'</span><span class="p">,</span><span class="s">'design_file'</span><span class="p">)]),</span>
   <span class="p">])</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">modelgen</span><span class="p">,</span> <span class="s">'con_file'</span><span class="p">,</span> <span class="n">modelestimate</span><span class="p">,</span> <span class="s">'tcon_file'</span><span class="p">)</span></code></pre></figure>

<p>The output from <code class="highlighter-rouge">modelestimate</code> is what we see in FSL level 1 analysis.</p>

<h2 id="level-2">Level 2</h2>

<p>One of the main issues we may see in Nipepe examples is that they recommend first running FLAMEO in level 2, and then registering its outputs to the standard space. Well, if you assume that subjects never move between runs, this might be appropriate. When was the last time you saw subjects being completely still?! Rhetorical question… Thus, we will be applying our registration matrices right after the copes, varcopes, etc. were created in level 1, then merging them and running FLAMEO on them.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">merge_mat</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">Merge</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s">'in2'</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s">'merge_mat'</span><span class="p">)</span>

<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">datasource</span><span class="p">,</span> <span class="s">'itk_transform'</span><span class="p">,</span> <span class="n">merge_mat</span><span class="p">,</span> <span class="s">'in2'</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">datasource</span><span class="p">,</span> <span class="s">'composite_transform'</span><span class="p">,</span> <span class="n">merge_mat</span><span class="p">,</span> <span class="s">'in1'</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">warp_files</span><span class="p">(</span><span class="n">copes</span><span class="p">,</span> <span class="n">varcopes</span><span class="p">,</span> <span class="n">masks</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">template_brain</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">nipype.interfaces.ants</span> <span class="k">as</span> <span class="n">ants</span>

    <span class="n">out_copes</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">out_varcopes</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">out_masks</span><span class="o">=</span><span class="p">[]</span>

    <span class="n">warp</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">ApplyTransforms</span><span class="p">()</span>
    <span class="n">warp</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">input_image_type</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">warp</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">interpolation</span> <span class="o">=</span> <span class="s">'Linear'</span>
    <span class="n">warp</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">invert_transform_flags</span> <span class="o">=</span> <span class="p">[</span><span class="bp">False</span><span class="p">,</span><span class="bp">False</span><span class="p">]</span>
    <span class="n">warp</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">terminal_output</span> <span class="o">=</span> <span class="s">'file'</span>
    <span class="n">warp</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">reference_image</span> <span class="o">=</span> <span class="n">template_brain</span>
    <span class="n">warp</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">transforms</span><span class="o">=</span><span class="n">mat</span>

    <span class="n">warp</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">input_image</span> <span class="o">=</span> <span class="n">masks</span>
    <span class="n">res</span><span class="o">=</span><span class="n">warp</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="n">out_masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">output_image</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">cope</span> <span class="ow">in</span> <span class="n">copes</span><span class="p">:</span>
        <span class="n">warp</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">input_image</span> <span class="o">=</span> <span class="n">cope</span>
        <span class="n">res</span><span class="o">=</span><span class="n">warp</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="n">out_copes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">output_image</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">varcope</span> <span class="ow">in</span> <span class="n">varcopes</span><span class="p">:</span>
        <span class="n">warp</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">input_image</span> <span class="o">=</span> <span class="n">varcope</span>
        <span class="n">res</span><span class="o">=</span><span class="n">warp</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="n">out_varcopes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">output_image</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">out_copes</span><span class="p">,</span> <span class="n">out_varcopes</span><span class="p">,</span> <span class="n">out_masks</span>

<span class="n">warpfunc</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s">'copes'</span><span class="p">,</span> <span class="s">'varcopes'</span><span class="p">,</span> <span class="s">'masks'</span><span class="p">,</span> <span class="s">'mat'</span><span class="p">,</span><span class="s">'template_brain'</span><span class="p">],</span>
                               <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s">'out_copes'</span><span class="p">,</span> <span class="s">'out_varcopes'</span><span class="p">,</span> <span class="s">'out_masks'</span><span class="p">],</span>
                               <span class="n">function</span><span class="o">=</span><span class="n">warp_files</span><span class="p">),</span>
                               <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s">'copes'</span><span class="p">,</span> <span class="s">'varcopes'</span><span class="p">,</span> <span class="s">'masks'</span><span class="p">,</span><span class="s">'mat'</span><span class="p">],</span>
                  <span class="n">name</span><span class="o">=</span><span class="s">'warpfunc'</span><span class="p">)</span>

<span class="n">warpfunc</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">template_brain</span> <span class="o">=</span> <span class="n">template_brain</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">modelestimate</span><span class="p">,</span> <span class="s">'copes'</span><span class="p">,</span> <span class="n">warpfunc</span><span class="p">,</span> <span class="s">'copes'</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">modelestimate</span><span class="p">,</span> <span class="s">'varcopes'</span><span class="p">,</span> <span class="n">warpfunc</span><span class="p">,</span> <span class="s">'varcopes'</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dilatemask</span><span class="p">,</span> <span class="s">'out_file'</span><span class="p">,</span> <span class="n">warpfunc</span><span class="p">,</span> <span class="s">'masks'</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">merge_mat</span><span class="p">,</span> <span class="s">'out'</span><span class="p">,</span> <span class="n">warpfunc</span><span class="p">,</span> <span class="s">'mat'</span><span class="p">)</span></code></pre></figure>

<p>As you see, we do not do anything different from registering example_func in <a href="https://dpaniukov.github.io/2016/07/03/three-level-analysis-with-fsl-and-ants-1.html">Part 1</a>.</p>

<p>Now merge the copes, varcopes and masks for each condition</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">copemerge</span>    <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">Merge</span><span class="p">(</span><span class="n">dimension</span><span class="o">=</span><span class="s">'t'</span><span class="p">),</span>
                          <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s">'in_files'</span><span class="p">],</span>
                          <span class="n">name</span><span class="o">=</span><span class="s">"copemerge"</span><span class="p">)</span>

<span class="n">varcopemerge</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">Merge</span><span class="p">(</span><span class="n">dimension</span><span class="o">=</span><span class="s">'t'</span><span class="p">),</span>
                       <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s">'in_files'</span><span class="p">],</span>
                       <span class="n">name</span><span class="o">=</span><span class="s">"varcopemerge"</span><span class="p">)</span>

<span class="n">maskemerge</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">Merge</span><span class="p">(</span><span class="n">dimension</span><span class="o">=</span><span class="s">'t'</span><span class="p">),</span>
                       <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s">'in_files'</span><span class="p">],</span>
                       <span class="n">name</span><span class="o">=</span><span class="s">"maskemerge"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">sort_copes</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
    <span class="n">numelements</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">outfiles</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numelements</span><span class="p">):</span>
        <span class="n">outfiles</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="p">,[])</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">elements</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
            <span class="n">outfiles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elements</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">outfiles</span>

<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">warpfunc</span><span class="p">,</span> <span class="p">(</span><span class="s">'out_copes'</span><span class="p">,</span><span class="n">sort_copes</span><span class="p">),</span> <span class="n">copemerge</span><span class="p">,</span> <span class="s">'in_files'</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">warpfunc</span><span class="p">,</span> <span class="p">(</span><span class="s">'out_varcopes'</span><span class="p">,</span><span class="n">sort_copes</span><span class="p">),</span> <span class="n">varcopemerge</span><span class="p">,</span> <span class="s">'in_files'</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">warpfunc</span><span class="p">,</span> <span class="p">(</span><span class="s">'out_masks'</span><span class="p">,</span><span class="n">sort_copes</span><span class="p">),</span> <span class="n">maskemerge</span><span class="p">,</span> <span class="s">'in_files'</span><span class="p">)</span></code></pre></figure>

<p>Setup a set of contrasts for level 2</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">get_contrasts_l2</span><span class="p">(</span><span class="n">contrast_file</span><span class="p">,</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">conds</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
    <span class="n">contrast_def</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">contrast_file</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">contrast_def</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">contrast_def</span> <span class="o">=</span> <span class="n">contrast_def</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">contrasts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">contrast_def</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">'task</span><span class="si">%03</span><span class="s">d'</span> <span class="o">%</span> <span class="n">task_id</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">con</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">'T'</span><span class="p">,</span> <span class="p">[</span><span class="s">'ev</span><span class="si">%03</span><span class="s">d'</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">conds</span><span class="p">))],</span>
               <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>
        <span class="n">contrasts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">con</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">contrasts</span>

<span class="n">contrastgen_l2</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s">'contrast_file'</span><span class="p">,</span>
                                                <span class="s">'task_id'</span><span class="p">,</span> <span class="s">'conds'</span><span class="p">],</span>
                                   <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s">'contrasts'</span><span class="p">],</span>
                                   <span class="n">function</span><span class="o">=</span><span class="n">get_contrasts_l2</span><span class="p">),</span>
                      <span class="n">name</span><span class="o">=</span><span class="s">'contrastgen_l2'</span><span class="p">)</span>

<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">subjinfo</span><span class="p">,</span> <span class="s">'conds_l2'</span><span class="p">,</span> <span class="n">contrastgen_l2</span><span class="p">,</span> <span class="s">'conds'</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">datasource</span><span class="p">,</span> <span class="s">'contrasts_l2'</span><span class="p">,</span> <span class="n">contrastgen_l2</span><span class="p">,</span> <span class="s">'contrast_file'</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">subjinfo</span><span class="p">,</span> <span class="s">'task_id'</span><span class="p">,</span> <span class="n">contrastgen_l2</span><span class="p">,</span> <span class="s">'task_id'</span><span class="p">)</span></code></pre></figure>

<p>Here we will use <code class="highlighter-rouge">MultipleRegressDesign</code> instead of <code class="highlighter-rouge">L2Model</code> recommended in Nipype examples to generate subject and condition-specific level 2 model design files because <code class="highlighter-rouge">MultipleRegressDesign</code> can handle more than one EV according to its name… ((c) Captain Obvious)</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">level2model</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">MultipleRegressDesign</span><span class="p">(),</span>
                      <span class="n">name</span><span class="o">=</span><span class="s">'l2model'</span><span class="p">)</span>

<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">contrastgen_l2</span><span class="p">,</span> <span class="s">'contrasts'</span><span class="p">,</span> <span class="n">level2model</span><span class="p">,</span> <span class="s">'contrasts'</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">subjinfo</span><span class="p">,</span> <span class="s">'evs_l2'</span><span class="p">,</span> <span class="n">level2model</span><span class="p">,</span> <span class="s">'regressors'</span><span class="p">)</span></code></pre></figure>

<p>Estimate a second level model with FLAMEO</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">flameo</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">FLAMEO</span><span class="p">(</span><span class="n">run_mode</span><span class="o">=</span><span class="s">'fe'</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s">"flameo"</span><span class="p">,</span>
                    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s">'cope_file'</span><span class="p">,</span><span class="s">'var_cope_file'</span><span class="p">])</span>

<span class="n">pickfirst</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">([(</span><span class="n">copemerge</span><span class="p">,</span><span class="n">flameo</span><span class="p">,[(</span><span class="s">'merged_file'</span><span class="p">,</span><span class="s">'cope_file'</span><span class="p">)]),</span>
          <span class="p">(</span><span class="n">varcopemerge</span><span class="p">,</span><span class="n">flameo</span><span class="p">,[(</span><span class="s">'merged_file'</span><span class="p">,</span><span class="s">'var_cope_file'</span><span class="p">)]),</span>
          <span class="p">(</span><span class="n">level2model</span><span class="p">,</span><span class="n">flameo</span><span class="p">,</span> <span class="p">[(</span><span class="s">'design_mat'</span><span class="p">,</span><span class="s">'design_file'</span><span class="p">),</span>
                                <span class="p">(</span><span class="s">'design_con'</span><span class="p">,</span><span class="s">'t_con_file'</span><span class="p">),</span>
                                <span class="p">(</span><span class="s">'design_grp'</span><span class="p">,</span><span class="s">'cov_split_file'</span><span class="p">)]),</span>
          <span class="p">(</span><span class="n">maskemerge</span><span class="p">,</span><span class="n">flameo</span><span class="p">,[((</span><span class="s">'merged_file'</span><span class="p">,</span><span class="n">pickfirst</span><span class="p">),</span><span class="s">'mask_file'</span><span class="p">)]),</span>
          <span class="p">])</span></code></pre></figure>

<p>Saving output since we are running this code for a single subject and will be combining data across subjects in level 3. Also, let’s save filtered_func_data just in case we need it sometime later, like to create means for timeseries and use them as inputs in PPI.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">datasink</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">nio</span><span class="o">.</span><span class="n">DataSink</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">'sinker'</span><span class="p">)</span>
<span class="n">datasink</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">base_directory</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">project_dir</span><span class="p">,</span> <span class="s">"level2s"</span><span class="p">,</span><span class="s">"model"</span><span class="o">+</span><span class="n">model_id</span><span class="p">)</span>

<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">infosource</span><span class="p">,</span> <span class="s">'subject_id'</span><span class="p">,</span> <span class="n">datasink</span><span class="p">,</span> <span class="s">'container'</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">highpass</span><span class="p">,</span> <span class="s">'out_file'</span><span class="p">,</span> <span class="n">datasink</span><span class="p">,</span> <span class="s">'filtered_func_data'</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">([(</span><span class="n">flameo</span><span class="p">,</span> <span class="n">datasink</span><span class="p">,</span> <span class="p">[(</span><span class="s">'stats_dir'</span><span class="p">,</span> <span class="s">'stats_dir'</span><span class="p">)])])</span></code></pre></figure>

<p>Run, Forrest….</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">results</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">plugin</span><span class="o">=</span><span class="s">'MultiProc'</span><span class="p">)</span></code></pre></figure>

<p>This is it for the preprocessing, levels 1 and 2. Next time, I will post my code for level 3 with some explanations.</p>

<p>I would like to thank Dr. Tyler Davis for his guidance and help with FSL and quality checking. Of course, all possible inaccuracies in the code are mine.</p>


  </div>

</article>

      </div>
    </div>

    <!--
<footer class="site-footer">

  <div class="wrapper">
-->
    <!--<h2 class="footer-heading">Dmitrii Paniukov</h2>-->
<!--
    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Dmitrii Paniukov</li>
          <li><a href="mailto:dmitrii.paniukov@ttu.edu">dmitrii.paniukov@ttu.edu</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/dpaniukov"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">dpaniukov</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/DmitriiPaniukov"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">DmitriiPaniukov</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p></p>
      </div>
    </div>

  </div>

</footer>
-->


  


</body></html>